<html>
    <!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <title>My Game</title>
        <style>
            
                #screen {
                    border: 10px solid black;
                    image-rendering: pixelated;
                    image-rendering: crisp-edges;
                    image-rendering: -moz-crisp-edges;
                    width:400px;
                    height:400px;
                }
            
        </style>
        <script src="./scripts/keyboardListener.js"></script>
       
    </head>
    <body>
        <p>Test</p>
        <canvas id="screen" width="20" height="20"></canvas>

        <script>
        

            const screen = document.getElementById('screen');
            const context = screen.getContext('2d');

            
            function createGame(){
                const state = {
                    players:{},
                    fruits:{}
                }

                function addPlayer(command){
                    const playerId = command.playerId;
                    const playerX = command.playerX;
                    const playerY = command.playerY;

                    state.players[playerId] = { x:playerX, y:playerY };
                }

                function removePlayer(command){
                    const playerId = command.playerId;
                    delete state.players[playerId]
                }
                
                function movePlayer(command){
                    const { playerId, keyPressed } = command;
                    const player = state.players[playerId];

                    const moves = {
                        ArrowUp:()=> player.y>0 ? player.y-=1:false,
                        ArrowDown:()=> player.y<screen.height-1 ? player.y+=1 :false,
                        ArrowLeft:()=> player.x>0 ? player.x-=1:false,
                        ArrowRight:()=> player.x<screen.width-1? player.x+=1 :false,
                    }

                    const moveFunction = moves[keyPressed];

                    if( player && moveFunction){
                        moveFunction();
                        checkFruitCollision(player);
                    }

                }

                function addFruit(command){
                    const fruitId = command.fruitId;
                    const fruitX = command.fruitX;
                    const fruitY = command.fruitY;

                    state.fruits[fruitId] = { x:fruitX, y:fruitY };
                }

                function removeFruit(command){
                    const fruitId = command.fruitId;
                    delete state.fruits[fruitId]
                }

                function checkFruitCollision (player){
                        for(const fruitId in state.fruits){
                            const fruit = state.fruits[fruitId];

                            if( player.x === fruit.x && player.y === fruit.y){
                                console.log('bateu');
                                removeFruit({ fruitId })
                            }
                        }
                }
                return {
                    addPlayer,
                    removePlayer,
                    addFruit,
                    removeFruit,
                    movePlayer,
                    state
                }
            }

            const game = createGame();
            const keyboardListener = createKeyboardListener();
            keyboardListener.subscribe(game.movePlayer);
            
            

            renderScreen();

            function renderScreen(){
                context.clearRect(0,0, screen.width, screen.height);
                const { state } = game;

                for(const playerId in state.players){
                    const player = state.players[playerId];

                    context.fillStyle='black';
                    context.fillRect(player.x,player.y,1,1);
                }

                for(const fruitId in state.fruits){
                    const fruit = state.fruits[fruitId];

                    context.fillStyle='green';
                    context.fillRect(fruit.x,fruit.y,1,1);
                }

                requestAnimationFrame(renderScreen);
            }


        </script>
    </body>
</html>
